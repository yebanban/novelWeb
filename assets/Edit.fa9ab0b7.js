import{c as O,d as se,r as te,t as ue,_ as ie,b as ce,g as F,a as de}from"./Dialog.a944e9fb.js";import{d as j,i as U,o as C,c as k,a as c,u as D,h as z,b as me,r as d,e as pe,f as ve,w as Q,v as X,g as he,t as B,n as q,j as G,k as fe,l as Y,m as L,p as H,q as ne,F as ae,s as le,x as R,T as J,y as K,z as ge,A as xe,B as Z,C as ee}from"./index.7669b82f.js";const Ce=c("div",{border:"1 blue-100",rounded:"1/2","p-6":""},[c("div",{"btn-logo":"","i-ph:plus":"",text:"gray-400"})],-1),_e=c("span",{text:"gray-600"},"\u65B0\u5EFA\u7AE0\u8282",-1),be=[Ce,_e],we=j({setup(e){const r=U("openNewChapterDialog");return(m,t)=>(C(),k("article",null,[c("div",{"rounded-3xl":"",bg:"white",h:"[80vh]",w:"4/5","m-auto":"",flex:"~ col gap-4","justify-center":"","items-center":"","cursor-pointer":"",onClick:t[0]||(t[0]=(...s)=>D(r)&&D(r)(...s))},be)]))}});function ye(e){return z.request({url:"newChapter",method:"post",data:e})}function Ie(e){return z.request({url:`getChapterContent?id=${e.id}`})}function ke(e){return z.request({url:"updateChapterName",method:"post",data:e})}function Ee(e){return z.request({url:"updateChapterContent",method:"post",data:e})}function Te(e){return z.request({url:"deletechapter",method:"post",data:e})}var S={create:ye,getChapterContent:Ie,updateChapterName:ke,updateChapterContent:Ee,deleteChapter:Te};const oe=me("main",{state:()=>({article:{id:"",title:"",content:""}}),getters:{id:e=>e.article.id,title:e=>e.article.title,content:e=>e.article.content,contentWordsCount:e=>O(e.article.content)},actions:{setTitle(e){this.article.title=e},setContent(e){this.article.content=e},updateChapter(e,r,m){this.article.id=e,this.article.title=r,this.article.content=m}}}),Ne={"md:mt-10":"","mt-4":"","min-h":"4/5",bg:"white","whitespace-pre-wrap":"","rounded-3xl":"",p:"x-3 md:x-10 y-6",relative:"",font:"sans"},De={p:"y-2 x-2",text:"sm gray-400",flex:"",justify:"between"},Ae={text:"right"},$e=["contenteditable"],Se=j({emits:["updateTitle"],setup(e,{expose:r,emit:m}){const t=oe(),s=d(t.title),E=d(" "),y=d(!1),I=d(!1),b=d(null),p=d(null),N=d(0),T=()=>{s.value=t.title,y.value=!0},_=()=>{y.value=!1},$=async()=>{I.value=!I.value,I.value||(await u(p.value,!1),V())},g=l=>{l.preventDefault();let w="",x=null;w=l.clipboardData.getData("text/plain"),x=window.getSelection().getRangeAt(0),x.deleteContents();let n=document.createTextNode(w);x.insertNode(n),x.collapse(!1),h(l.target,!0),A()};async function u(l,w){try{let x=l.innerText;await S.updateChapterContent({id:t.id,content:x}),t.setContent(x);let n=new Date;E.value=`\u6587\u7AE0${w?"\u81EA\u52A8":""}\u4FDD\u5B58\u4E8E${n.toLocaleTimeString()}`}catch(x){alert(x)}}async function o(l){try{l=l||" ",t.setTitle(l),m("updateTitle",t.id,l),await S.updateChapterName({id:t.id,title:l})}catch(w){alert(w)}}const A=async()=>{var l;await G(),N.value=O((l=p.value)==null?void 0:l.innerText)},{fnDebounced:h,clearTime:V}=se(u,2e3),P=l=>{y.value&&l.target!=b.value&&(_(),s.value=te(s.value),o(s.value),l.stopPropagation())};return r({changeContentWordsCount:A,contentEditor:p}),pe(()=>{var l;window.addEventListener("click",P,!0),N.value=O((l=p.value)==null?void 0:l.innerText)}),ve(()=>{window.removeEventListener("click",P)}),(l,w)=>(C(),k("article",null,[c("div",{"w-full":"",onDblclick:T,text:"lg center","font-bold":""},[Q(c("input",{w:"full",type:"text","onUpdate:modelValue":w[0]||(w[0]=x=>s.value=x),border:"0 gray-500 b-2",outline:"none",bg:"transparent",text:"lg center",font:"bold sans",ref_key:"titleInput",ref:b},null,512),[[X,y.value],[he,s.value]]),Q(c("div",{"font-sans":"",border:"0 b-2 transparent","whitespace-pre-wrap":""},B(D(t).title?D(t).title:" "),513),[[X,!y.value]])],32),c("div",Ne,[c("div",{class:q(I.value?"i-mdi:content-save":"i-mdi:pen"),absolute:"","top-3":"","right-5":"","btn-logo":"",text:"gray-600",onClick:$},null,2),c("div",De,[c("span",null,"\u672C\u7AE0\u5B57\u6570\uFF1A"+B(N.value),1),c("span",Ae,B(E.value),1)]),c("div",{"min-h":"[68vh]","w-full":"","inline-block":"","outline-none":"",contenteditable:I.value,text:"base",ref_key:"contentEditor",ref:p,onInput:w[1]||(w[1]=x=>{D(h)(x.target,!0),A()}),onPaste:g},B(D(t).content),41,$e)])]))}});var re=(e,r)=>{const m=e.__vccOpts||e;for(const[t,s]of r)m[t]=s;return m};const Me=["onClick"],Fe=["onClick"],Be=j({props:{name:null,logo:null,menuItems:null,duration:{default:.5},menuScrollIndex:null},emits:["clickMe"],setup(e,{emit:r}){const m=e,t=d(null),s=d(!1),E=d(""),y=U("openNewChapterDialog"),I=U("deleteCatalogItem"),b=u=>{s.value=!0,E.value=u},p=d(!1),N=ue(()=>{m.menuItems&&(p.value=!p.value,G().then(()=>{const u=m.menuItems.findIndex(o=>o.selected===!0);g(u)}))},m.duration*1e3),T=u=>u.selected?"bg-blue-100/50 hover:bg-blue-100/50":"hover:bg-blue-100/20",_=u=>{var o;(o=m.menuItems)==null||o.forEach(A=>A.selected=!1),u.selected=!0},$=async u=>{s.value=!1;try{await S.deleteChapter({id:u}),I&&await I(u)}catch(o){alert(o)}},g=u=>{G().then(function(){var o;(o=t.value)==null||o.scrollTo(0,u<=3?0:(u-3)*32.7)})};return fe(()=>m.menuScrollIndex,u=>{g(u)}),(u,o)=>{const A=ie;return C(),k("div",null,[c("div",{"menu-item":"",onClick:o[0]||(o[0]=h=>{D(N)(),r("clickMe")}),class:q({"bg-blue-200/400":p.value,"hover:bg-blue-200/400":p.value}),"mb-1":""},[c("div",{class:q(e.logo),text:"base"},null,2),Y(" "+B(e.name),1)],2),L(J,{appear:"",name:"itemList"},{default:H(()=>[p.value?(C(),k("div",{key:0,style:ne({"transition-duration":e.duration+"s"}),"max-h":"[38vh]",shadow:"sm gray-200","rounded-lg":"","box-border":"","overflow-hidden":""},[c("div",{p:"l-4 r-2 y-2",text:"xs center",cursor:"pointer","border-gray-100":"",border:"0 b-1",onClick:o[1]||(o[1]=(...h)=>D(y)&&D(y)(...h)),bg:"red-100/40 hover:red-100/70 active:red-100"}," \u65B0\u5EFA\u7AE0\u8282 "),c("div",{"max-h":"[33vh]","overflow-y-auto":"",class:"hideScrollbar",ref_key:"menu",ref:t},[(C(!0),k(ae,null,le(e.menuItems,h=>(C(),k("div",{p:"l-4 r-2 y-2",text:"xs",cursor:"pointer","border-gray-100":"",border:"0 b-1",truncate:"",relative:"",key:h.id,onClick:V=>{h.clickMe(),_(h)},class:q([T(h),"item"])},[Y(B(h.itemName)+" ",1),h.canDelete?(C(),k("div",{key:0,class:"delete",hidden:"","btn-logo":"","i-mdi:trash-can-outline":"",absolute:"",right:"1",top:"1/2","translate-y":"-1/2",onClick:V=>b(h.id)},null,8,Fe)):R("",!0)],10,Me))),128))],512)],4)):R("",!0)]),_:1}),L(A,{modelValue:s.value,"onUpdate:modelValue":o[2]||(o[2]=h=>s.value=h),tips:"\u662F\u5426\u5220\u9664\u8BE5\u7AE0\u8282\uFF1F",onClickEnter:o[3]||(o[3]=h=>$(E.value))},null,8,["modelValue"])])}}});var Le=re(Be,[["__scopeId","data-v-586428e5"]]);const Ve={key:0,"w-65":"","h-screen":"","rounded-r-3xl":"","bg-white":"",fixed:"","z-10":"",flex:"~ col gap-8","items-center":""},We={"m-y-25":"",h:"[70vh]","w-53":"",font:"sans semibold",text:"sm gray-600",flex:"~ col gap-3","select-none":""},qe={key:0,h:"20",shadow:"lg blue-500/50","bg-white":"","rounded-r-xl":"",top:"[40vh]",flex:"",justify:"center","items-center":"",fixed:""},Ue=j({props:{novelId:null,menuList:null,menuScrollIndex:null},emits:["expand","close"],setup(e,{emit:r}){const m=d(null),t=d(!1),s=()=>{t.value=!0,r("expand")},E=()=>{t.value=!1,r("close")};return(y,I)=>(C(),k("aside",null,[L(J,{name:"menu"},{default:H(()=>[t.value?(C(),k("div",Ve,[c("div",We,[(C(!0),k(ae,null,le(e.menuList,(b,p)=>(C(),K(Le,{key:p,name:b.name,logo:b.logo,menuScrollIndex:e.menuScrollIndex,"menu-items":b.menuItems,duration:b.duration,onClickMe:N=>b.clickMe?b.clickMe():null,ref_for:!0,ref_key:"menuModal",ref:m},null,8,["name","logo","menuScrollIndex","menu-items","duration","onClickMe"]))),128))]),c("div",{"i-mdi:close":"","btn-logo":"",absolute:"","top-3":"","right-3":"",text:"gray-600",onClick:E})])):R("",!0)]),_:1}),L(J,{name:"expand"},{default:H(()=>[t.value?R("",!0):(C(),k("div",qe,[c("div",{btn:"","i-mdi:menu":"","px-2":"",onClick:s})]))]),_:1})]))}});var je=re(Ue,[["__scopeId","data-v-0ca8fd82"]]);const Re=j({async setup(e){let r,m;const t=d(null),s=d(0),E=d("0"),y=ge(),I=xe(),b=d(y.params.name),p=oe(),N=d(y.params.id),T=d(),_=d(),$=d(!1);document.title=b.value;const g=U("setLoading"),u=U("loading"),o=(n,v,a)=>({id:n,itemName:v,selected:a,canDelete:!0,clickMe:async function(){var f;if(!this.selected){g(!0);try{let i=(await S.getChapterContent({id:this.id})).result.content;p.updateChapter(this.id,this.itemName,i),window.scrollTo(0,0),await((f=t.value)==null?void 0:f.changeContentWordsCount())}catch(i){alert(i)}g(!1)}}});try{if(g(!0),T.value=([r,m]=Z(()=>ce.getChapters({id:N.value})),r=await r,m(),r).result.chapters,T.value.sort((n,v)=>F(n.title)-F(v.title)),T.value.length>0){let n=([r,m]=Z(()=>S.getChapterContent({id:T.value[0].id})),r=await r,m(),r).result.content;p.updateChapter(T.value[0].id,T.value[0].title,n)}g(!1),_.value=[{name:"\u4E3B\u9875",logo:"i-ph:house",clickMe:()=>{I.push("/home")}},{name:"\u76EE\u5F55",logo:"i-mdi:format-align-right",menuItems:T.value.map((n,v)=>o(n.id,n.title,v===0))},{name:"\u8BBE\u7F6E",logo:"i-ph:nut-bold"},{name:"\u5173\u4E8E",logo:"i-mdi:information-outline"}]}catch(n){g(!1),alert(n),I.push("/home")}const A=(n,v)=>{if(_.value){const a=_.value[1].menuItems;if(a){let f=a.findIndex(i=>i.id===n);a[f].itemName=v,a.sort((i,M)=>F(i.itemName)-F(M.itemName)),f=a.findIndex(i=>i.id===n),s.value=f}}},h=(n,v)=>{if(_.value){const a=_.value[1].menuItems;if(a){let f=a.findIndex(i=>F(i.itemName)>F(v));f===-1&&(f=a.length),a.forEach(i=>i.selected=!1),a.splice(f,0,o(n,v,!0)),s.value=f}}},V=()=>{$.value=!0},P=async n=>{var v;if(_.value){const a=_.value[1].menuItems;if(a){let f=a.findIndex(W=>W.id===n);if(a.splice(f,1),a.length===0){p.updateChapter("","","");return}else f===a.length&&f--;const i=a[f];g(!0);let M=(await S.getChapterContent({id:i.id})).result.content;g(!1),a.forEach(W=>W.selected=!1),i.selected=!0,p.updateChapter(i.id,i.itemName,M),window.scrollTo(0,0),await((v=t.value)==null?void 0:v.changeContentWordsCount())}}},l=async n=>{var v;try{g(!0),n=te(n);const a=(await S.create({bookId:N.value,chapterName:n})).result.id;g(!1),h(a,n),p.updateChapter(a,n,""),window.scrollTo(0,0),await((v=t.value)==null?void 0:v.changeContentWordsCount())}catch(a){g(!1),alert(a)}};ee("openNewChapterDialog",V),ee("deleteCatalogItem",P);const w=()=>{E.value=16.25+"rem"},x=()=>{E.value="0"};return(n,v)=>{var i,M;const a=we,f=de;return C(),k("div",{bg:"light-600","min-h":"full",flex:"",class:q(D(u)?"blur-sm":"")},[L(je,{onExpand:w,onClose:x,novelId:N.value,menuList:_.value,menuScrollIndex:s.value,"z-10":""},null,8,["novelId","menuList","menuScrollIndex"]),c("div",{style:ne({width:E.value}),"min-h":"full","duration-500":"","ease-in-out":""},null,4),_.value&&((M=(i=_.value[1])==null?void 0:i.menuItems)==null?void 0:M.length)?(C(),K(Se,{key:0,"md:my-8":"","md:mx-16":"","my-4":"","mx-1":"",flex:"1",ref_key:"modal",ref:t,onUpdateTitle:A},null,512)):(C(),K(a,{key:1,my:"[10vh]","mx-16":"",flex:"1"})),L(f,{modelValue:$.value,"onUpdate:modelValue":v[0]||(v[0]=W=>$.value=W),onClickEnter:l,title:"\u65B0\u5EFA\u7AE0\u8282",placeholder:"\u8BF7\u8F93\u5165\u65B0\u7AE0\u8282\u540D"},null,8,["modelValue"])],2)}}});export{Re as default};
